<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Посты</title>
  <!-- Подключение jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- Подключение jQuery QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <script type="module">


    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhJwmFlIgXt0z6gcoErRTXQo3kkjDqOuo",
      authDomain: "lastp-44a37.firebaseapp.com",
      databaseURL: "https://lastp-44a37-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lastp-44a37",
      storageBucket: "lastp-44a37.appspot.com",
      messagingSenderId: "972643290372",
      appId: "1:972643290372:web:c42fdc293cf8cac0609451",
      measurementId: "G-C7R84JG5XZ"
    };





    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const postsContainer = document.getElementById('postsContainer');
    const titleFilterInput = document.getElementById('titleFilter');
    const dateFilterInput = document.getElementById('dateFilter');
    const keywordsFilterInput = document.getElementById('keywordsFilter');

    const loginButton = document.getElementById('loginButton');
    const loginModal = document.getElementById('loginModal');
    const closeModal = document.getElementById('closeModal');
    const submitLogin = document.getElementById('submitLogin');

    const createPostButton = document.getElementById('createPostButton');
    const createPostModal = document.getElementById('createPostModal');
    const closeCreatePostModal = document.getElementById('closeCreatePostModal');
    const submitPostButton = document.getElementById('submitPostButton');

    createPostButton.onclick = function() {
      createPostModal.style.display = "block";
      loadEventsForSelect(); // Загрузка мероприятий при открытии модального окна
    }

    closeCreatePostModal.onclick = function() {
      createPostModal.style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target === createPostModal) {
        createPostModal.style.display = "none";
      }
      if (event.target === loginModal) {
        loginModal.style.display = "none";
      }
    }



    function openEvent(bannerId) {
      const eventRef = ref(database, 'banners/' + bannerId);
      get(eventRef).then((snapshot) => {
        if (snapshot.exists()) {
          const eventData = snapshot.val();
          document.getElementById('eventTheme').innerText = eventData.theme;
          document.getElementById('eventDescription').innerText = eventData.description;
          document.getElementById('eventMetka').innerText = eventData.metka;
          document.getElementById('eventImage').src = eventData.imageUrl;

          // Генерация QR-кода
          const appLink = "https://logo-2-0.vercel.app/index.html?bannerId=" + bannerId; // Ссылка для веб-сайта
          generateQRCode(appLink); // Генерируем QR-код

          // Открываем модальное окно
          document.getElementById('eventDetailsModal').style.display = "block";
        } else {
          alert("Данные мероприятия не найдены.");
        }
      }).catch((error) => {
        console.error("Ошибка при получении данных мероприятия:", error);
      });
    }



    submitPostButton.onclick = function() {
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      const imageInput = document.getElementById('postImage');
      const imageFile = imageInput.files[0];
      const eventId = document.getElementById('eventSelect').value; // Получаем выбранное мероприятие

      if (!title || !content || !imageFile || !eventId) {
        alert("Пожалуйста, заполните все поля.");
        return;
      }

      uploadPost(title, content, imageFile, eventId); // Передаем eventId
    }

    function uploadPost(title, content, imageFile, eventId) {
      if (!auth.currentUser ) {
        alert("Пожалуйста, войдите в систему, чтобы создать пост.");
        return;
      }

      const progressDialog = document.createElement('div');
      progressDialog.innerText = "Загрузка поста...";
      document.body.appendChild(progressDialog);

      const storageReference = storageRef(storage, 'uploads/' + imageFile.name);
      const uploadTask = uploadBytes(storageReference, imageFile);

      uploadTask.then((snapshot) => {
        console.log('Изображение загружено:', snapshot);
        return getDownloadURL(snapshot.ref);
      }). then((downloadURL) => {
        const postId = Date.now().toString(); // Используем временную метку как уникальный ID
        const authorId = auth.currentUser .uid; // Получаем ID автора
        const post = {
          id: postId,
          authorId: authorId,
          title: title,
          content: content,
          imageUrl: downloadURL,
          date: new Date().toISOString(),
          keywords: [],
          likes: 0, // Инициализируем лайки
          comments: {}, // Инициализируем комментарии
          rulseId: eventId // Добавляем ID мероприятия
        };

        // Сохранение поста в базе данных
        set(ref(database, 'posts/' + postId), post)
          .then(() => {
            progressDialog.innerText = "Пост успешно загружен!";
            setTimeout(() => {
              progressDialog.remove();
              createPostModal.style.display = "none"; // Закрываем модальное окно
              document.getElementById('postTitle').value = ''; // Очищаем поля
              document.getElementById('postContent').value = '';
              imageInput.value = ''; // Очищаем поле выбора файла
              loadPosts(); // Обновляем список постов
            }, 2000); // Закрываем окно через 2 секунды
          })
          .catch((error) => {
            console.error("Ошибка при сохранении поста:", error);
            progressDialog.innerText = "Ошибка при сохранении поста.";
          });
      }).catch((error) => {
        console.error("Ошибка загрузки:", error);
        progressDialog.innerText = "Ошибка загрузки.";
      });
    }

    // Функция для загрузки мероприятий и заполнения выпадающего списка
    function loadEventsForSelect() {
      const eventsRef = ref(database, 'banners');
      get(eventsRef).then((snapshot) => {
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = ''; // Очистка списка перед добавлением новых элементов

        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const event = childSnapshot.val();
            const option = document.createElement('option');
            option.value = event.id; // Используем ID мероприятия
            option.textContent = event.theme; // Отображаем тему мероприятия
            eventSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = 'Нет доступных мероприятий';
          eventSelect.appendChild(option);
        }
      }).catch((error) => {
        console.error("Ошибка при загрузке мероприятий:", error);
      });
    }









    loginButton.onclick = function() {
      loginModal.style.display = "block";
    }

    closeModal.onclick = function() {
      loginModal.style.display = "none";
    }

    submitLogin.onclick = function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      loginUser (email, password);
    }

    function loginUser (email, password) {
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          // Успешный вход
          alert("Вы успешно вошли!");
          loginModal.style.display = "none";
          loginButton.innerText = "Вошел"; // Меняем текст кнопки
        })
        .catch((error) => {
          // Ошибка входа
          alert("Ошибка: " + error.message);
        });
    }

    // Загрузка постов из Firebase
    function loadPosts() {
      const postsRef = ref(database, 'posts');
      get(postsRef).then((snapshot) => {
        if (snapshot.exists()) {
          postsContainer.innerHTML = ''; // Очистка контейнера
          const posts = snapshot.val();
          for (const key in posts) {
            if (posts.hasOwnProperty(key)) {
              addPostToView(posts[key]);
            }
          }
        } else {
          postsContainer.innerHTML = 'Данные не найдены';
        }
      }).catch((error) => {
        console.error("Ошибка при получении данных: ", error);
      });
    }


    function addPostToView(post) {
      const postDiv = document.createElement('div');
      postDiv.classList.add('post');
      postDiv.innerHTML = `
        <h3>${post.title || 'Без заголовка'}</h3>
        <p>${post.content || 'Без содержания'}</p>
        <img src="${post.imageUrl || ''}" alt="Изображение поста" style="max-width: 100%; height: auto;">
        <p><strong>Дата:</strong> ${post.date || 'Нет даты'}</p>
        <p><strong>Ключевые слова:</strong> ${Array.isArray(post.keywords) && post.keywords.length > 0 ? post.keywords.join(', ') : 'Нет ключевых слов'}</p>
        <p><strong>Лайки:</strong> <span id="likes-${post.id}">${post.likes || 0}</span> <button id="likeButton-${post.id}">👍</button></p>
        <p><strong>Мероприятие:</strong> ${post.rulseId ? `<button id="eventButton-${post.id}">Подробнее</button>` : 'Не прикреплено'}</p>
        <h4>Комментарии:</h4>
        <div id="comments-${post.id}"></div>
        <input type="text" id="commentInput-${post.id}" placeholder="Ваш комментарий">
        <button id="addCommentButton-${post.id}">Добавить комментарий</button>
    `;
      postsContainer.appendChild(postDiv);

      // Добавление обработчиков событий
      document.getElementById(`likeButton-${post.id}`).onclick = () => likePost(post);
      document.getElementById(`addCommentButton-${post.id}`).onclick = () => addComment(post.id);

      // Обработчик для кнопки "Подробнее"
      if (post.rulseId) {
        document.getElementById(`eventButton-${post.id}`).onclick = () => {
          openEventDetails(post.rulseId); // Передаем rulseId и заголовок поста
        };
      }

      loadComments(post.id);
    }

    function openEventDetails(rulseId) {
      const eventRef = ref(database, 'banners/' + rulseId);
      get(eventRef).then((snapshot) => {
        if (snapshot.exists()) {
          const eventData = snapshot.val();
          document.getElementById('eventTheme').innerText = eventData.theme;
          document.getElementById('eventDescription').innerText = eventData.description;
          document.getElementById('eventMetka').innerText = eventData.metka;
          document.getElementById('eventImage').src = eventData.imageUrl;

          // Генерация QR-кода
          const bannerId = rulseId; // Используем rulseId как bannerId
          const appLink = "https://banner?bannerId=" + bannerId; // Ссылка для веб-сайта
          const webLink = "https://logo-2-0.vercel.app/index.html?bannerId=" + bannerId; // Ссылка для веб-сайта
          const finalLink = appLink + "||" + webLink; // Объединяем ссылки
          generateQRCode(finalLink); // Генерируем QR-код

          // Добавление обработчика клика на QR-код
          $('#qrcode').off('click').on('click', function() {
            const links = finalLink.split('||');
            const appLink = links[0];
            const webLink = links[1];

            // Попробуем открыть приложение
            window.location.href = appLink;

            // Устанавливаем таймер для перехода на веб-сайт через 1 секунду
            setTimeout(() => {
              window.location.href = webLink; // Переход на веб-сайт
            }, 1000); // Задержка в 1 секунду
          });

          // Открываем модальное окно
          document.getElementById('eventDetailsModal').style.display = "block";
        } else {
          alert("Данные мероприятия не найдены.");
        }
      }).catch((error) => {
        console.error("Ошибка при получении данных мероприятия:", error);
      });
    }

    function generateQRCode(link) {
      $('#qrcode').empty(); // Очистить предыдущий QR-код
      $('#qrcode').qrcode({
        text: link,
        width: 200,
        height: 200,
      });
    }


    // Закрытие модального окна
    document.getElementById('closeEventDetailsModal').onclick = function() {
      document.getElementById('eventDetailsModal').style.display = "none";
    }

    // Закрытие модального окна при клике вне его
    window.onclick = function(event) {
      if (event.target === document.getElementById('eventDetailsModal')) {
        document.getElementById('eventDetailsModal').style.display = "none";
      }
    }

    function likePost(post) {
      const userId = auth.currentUser .uid; // Получаем текущий ID пользователя
      if (!post.likedBy) {
        post.likedBy = []; // Инициализируем массив, если он не существует
      }

      if (!post.likedBy.includes(userId)) {
        post.likedBy.push(userId); // Добавляем пользователя в массив лайков
        post.likes++; // Увеличиваем количество лайков

        // Обновляем пост в базе данных
        set(ref(database, `posts/${post.id}`), post)
          .then(() => {
            document.getElementById(`likes-${post.id}`).innerText = post.likes; // Обновляем отображение лайков
            alert("Пост лайкнут!");
          })
          .catch((error) => {
            console.error("Ошибка при обновлении поста:", error);
            alert("Не удалось лайкнуть пост.");
          });
      } else {
        alert("Вы уже лайкнули этот пост.");
      }
    }

    function addComment(postId) {
      const commentInput = document.getElementById(`commentInput-${postId}`);
      const commentText = commentInput.value.trim();

      if (!auth.currentUser ) {
        alert("Пожалуйста, войдите в систему, чтобы добавить комментарий.");
        return;
      }

      if (!commentText) {
        alert("Пожалуйста, введите комментарий.");
        return;
      }

      const commentsRef = ref(database, `posts/${postId}/comments`);
      const newComment = {
        text: commentText,
        date: new Date().toISOString(),
        authorId: auth.currentUser .uid
      };

      push(commentsRef, newComment)
        .then(() => {
          commentInput.value = ''; // Очищаем поле ввода
          loadComments(postId); // Перезагружаем комментарии
          alert("Комментарий добавлен!");
        })
        .catch((error) => {
          console.error("Ошибка при добавлении комментария:", error);
          alert("Не удалось добавить комментарий. Попробуйте еще раз.");
        });
    }

    function loadComments(postId) {
      const commentsRef = ref(database, `posts/${postId}/comments`);
      onValue(commentsRef, (snapshot) => {
        const commentsDiv = document.getElementById(`comments-${postId}`);
        commentsDiv.innerHTML = ''; // Очищаем предыдущие комментарии

        snapshot.forEach((commentSnapshot) => {
          const comment = commentSnapshot.val();
          const commentElement = document.createElement('p');
          commentElement.innerText = `${comment.text}`;
          commentsDiv.appendChild(commentElement);
        });
      }, {
        onlyOnce: true // Загружаем комментарии только один раз
      });
    }
    // Функция для переключения видимости комментариев
    function toggleComments(button) {
      const commentsDiv = button.nextElementSibling;
      if (commentsDiv.style.display === 'none') {
        commentsDiv.style.display = 'block';
      } else {
        commentsDiv.style.display = 'none';
      }
    }

      // Фильтрация постов
    function filterPosts() {
      const titleFilter = titleFilterInput.value.toLowerCase();
      const dateFilter = dateFilterInput.value.toLowerCase();
      const keywordsFilter = keywordsFilterInput.value.toLowerCase().split(' ');

      const postsRef = ref(database, 'posts');
      onValue(postsRef, (snapshot) => {
        if (snapshot.exists()) {
          postsContainer.innerHTML = ''; // Очистка контейнера
          const posts = snapshot.val();
          for (const key in posts) {
            if (posts.hasOwnProperty(key)) {
              const post = posts[key];
              if (matchesFilter(post, titleFilter, dateFilter, keywordsFilter)) {
                addPostToView(post);
              }
            }
          }
        } else {
          postsContainer.innerHTML = 'Данные не найдены';
        }
      });
    }

    submitPostButton.onclick = function() {
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      const imageInput = document.getElementById('postImage');
      const imageFile = imageInput.files[0];
      const eventId = document.getElementById('eventSelect').value; // Получаем выбранное мероприятие

      if (!title || !content || !imageFile || !eventId) {
        alert("Пожалуйста, заполните все поля.");
        return;
      }

      uploadPost(title, content, imageFile, eventId); // Передаем eventId
    }

    // Проверка соответствия поста фильтрам
    function matchesFilter(post, titleFilter, dateFilter, keywordsFilter) {
      const matchesTitle = post.title.toLowerCase().includes(titleFilter);
      const matchesDate = post.date.includes(dateFilter);
      const matchesKeywords = keywordsFilter.every(keyword => post.keywords.includes(keyword));

      return matchesTitle && matchesDate && matchesKeywords;
    }

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const bannerId = urlParams.get('bannerId');

      if (bannerId) {
        openEvent(bannerId); // Открываем детали мероприятия
      }

      loadPosts();
      titleFilterInput.addEventListener('input', filterPosts);
      dateFilterInput.addEventListener('input', filterPosts);
      keywordsFilterInput.addEventListener('input', filterPosts);
    }

  </script>
  <style>

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .post {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    #loginModal, #createPostModal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #eventDetailsModal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<button onclick="window.location.href='rulse.html'">к мероприятиям</button>

<h1>Посты</h1>
<button id="loginButton">Войти</button>
<button id="createPostButton">Создать пост</button>

<div id="postsContainer"></div>

<div id="loginModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2>Вход</h2>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Пароль" required>
    <button id="submitLogin">Войти</button>
  </div>
</div>

<div id="createPostModal">
  <div class="modal-content">
    <span class="close" id="closeCreatePostModal">&times;</span>
    <h2>Создать пост</h2>
    <button onclick="uploadPost()">Создать пост</button>
    <select id="eventSelect">
      <option value="">Выберите мероприятие</option>
    </select>
    <input type="text" id="postTitle" placeholder="Заголовок" required>
    <textarea id="postContent" placeholder="Содержание" required></textarea>
    <input type="file" id="postImage" accept="image/*" required>
    <button id="submitPostButton">Создать пост</button>
  </div>
</div>

<div id="eventDetailsModal" style="display: none;">
  <div class="modal-content">
    <span class="close" id="closeEventDetailsModal">&times;</span>
    <h2 id="eventTheme"></h2>
    <img id="eventImage" src="" alt="Изображение мероприятия" style="max-width: 100%; height: auto;">
    <p><strong>Описание:</strong> <span id="eventDescription"></span></p>
    <p><strong>Метка:</strong> <span id="eventMetka"></span></p>
    <button id="signUpButton">Записаться</button>
    <div id="qrcode"></div>
  </div>
</div>

<input type="text" id="titleFilter" placeholder="Фильтр по заголовку">
<input type="text" id="dateFilter" placeholder="Фильтр по дате">
<input type="text" id="keywordsFilter" placeholder="Фильтр по ключевым словам">

</body>
</html>

