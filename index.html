<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ—Å—Ç—ã</title>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <script type="module">


    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get, onValue, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhJwmFlIgXt0z6gcoErRTXQo3kkjDqOuo",
      authDomain: "lastp-44a37.firebaseapp.com",
      databaseURL: "https://lastp-44a37-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lastp-44a37",
      storageBucket: "lastp-44a37.appspot.com",
      messagingSenderId: "972643290372",
      appId: "1:972643290372:web:c42fdc293cf8cac0609451",
      measurementId: "G-C7R84JG5XZ"
    };





    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const postsContainer = document.getElementById('postsContainer');
    const titleFilterInput = document.getElementById('titleFilter');
    const dateFilterInput = document.getElementById('dateFilter');
    const keywordsFilterInput = document.getElementById('keywordsFilter');

    const loginButton = document.getElementById('loginButton');
    const loginModal = document.getElementById('loginModal');
    const closeModal = document.getElementById('closeModal');
    const submitLogin = document.getElementById('submitLogin');

    const createPostButton = document.getElementById('createPostButton');
    const createPostModal = document.getElementById('createPostModal');
    const closeCreatePostModal = document.getElementById('closeCreatePostModal');
    const submitPostButton = document.getElementById('submitPostButton');

    createPostButton.onclick = function() {
      createPostModal.style.display = "block";
      loadEventsForSelect(); // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    }

    closeCreatePostModal.onclick = function() {
      createPostModal.style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target === createPostModal) {
        createPostModal.style.display = "none";
      }
      if (event.target === loginModal) {
        loginModal.style.display = "none";
      }
    }



    function openEvent(bannerId) {
      const eventRef = ref(database, 'banners/' + bannerId);
      get(eventRef).then((snapshot) => {
        if (snapshot.exists()) {
          const eventData = snapshot.val();
          document.getElementById('eventTheme').innerText = eventData.theme;
          document.getElementById('eventDescription').innerText = eventData.description;
          document.getElementById('eventMetka').innerText = eventData.metka;
          document.getElementById('eventImage').src = eventData.imageUrl;

          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
          const appLink = "https://logo-2-0.vercel.app/index.html?bannerId=" + bannerId; // –°—Å—ã–ª–∫–∞ –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞
          generateQRCode(appLink); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          document.getElementById('eventDetailsModal').style.display = "block";
        } else {
          alert("–î–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        }
      }).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:", error);
      });
    }



    submitPostButton.onclick = function() {
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      const imageInput = document.getElementById('postImage');
      const imageFile = imageInput.files[0];
      const eventId = document.getElementById('eventSelect').value; // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ

      if (!title || !content || !imageFile || !eventId) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
        return;
      }

      uploadPost(title, content, imageFile, eventId); // –ü–µ—Ä–µ–¥–∞–µ–º eventId
    }

    function uploadPost(title, content, imageFile, eventId) {
      if (!auth.currentUser ) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç.");
        return;
      }

      const progressDialog = document.createElement('div');
      progressDialog.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞...";
      document.body.appendChild(progressDialog);

      const storageReference = storageRef(storage, 'uploads/' + imageFile.name);
      const uploadTask = uploadBytes(storageReference, imageFile);

      uploadTask.then((snapshot) => {
        console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', snapshot);
        return getDownloadURL(snapshot.ref);
      }). then((downloadURL) => {
        const postId = Date.now().toString(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        const authorId = auth.currentUser .uid; // –ü–æ–ª—É—á–∞–µ–º ID –∞–≤—Ç–æ—Ä–∞
        const post = {
          id: postId,
          authorId: authorId,
          title: title,
          content: content,
          imageUrl: downloadURL,
          date: new Date().toISOString(),
          keywords: [],
          likes: 0, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–∞–π–∫–∏
          comments: {}, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
          rulseId: eventId // –î–æ–±–∞–≤–ª—è–µ–º ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        set(ref(database, 'posts/' + postId), post)
          .then(() => {
            progressDialog.innerText = "–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!";
            setTimeout(() => {
              progressDialog.remove();
              createPostModal.style.display = "none"; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
              document.getElementById('postTitle').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
              document.getElementById('postContent').value = '';
              imageInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
              loadPosts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤
            }, 2000); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          })
          .catch((error) => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:", error);
            progressDialog.innerText = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞.";
          });
      }).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        progressDialog.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.";
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function loadEventsForSelect() {
      const eventsRef = ref(database, 'banners');
      get(eventsRef).then((snapshot) => {
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const event = childSnapshot.val();
            const option = document.createElement('option');
            option.value = event.id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
            option.textContent = event.theme; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
            eventSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π';
          eventSelect.appendChild(option);
        }
      }).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:", error);
      });
    }









    loginButton.onclick = function() {
      loginModal.style.display = "block";
    }

    closeModal.onclick = function() {
      loginModal.style.display = "none";
    }

    submitLogin.onclick = function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      loginUser (email, password);
    }

    function loginUser (email, password) {
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
          alert("–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!");
          loginModal.style.display = "none";
          loginButton.innerText = "–í–æ—à–µ–ª"; // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        })
        .catch((error) => {
          // –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
          alert("–û—à–∏–±–∫–∞: " + error.message);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –∏–∑ Firebase
    function loadPosts() {
      const postsRef = ref(database, 'posts');
      get(postsRef).then((snapshot) => {
        if (snapshot.exists()) {
          postsContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          const posts = snapshot.val();
          for (const key in posts) {
            if (posts.hasOwnProperty(key)) {
              addPostToView(posts[key]);
            }
          }
        } else {
          postsContainer.innerHTML = '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        }
      }).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ", error);
      });
    }


    function addPostToView(post) {
      const postDiv = document.createElement('div');
      postDiv.classList.add('post');
      postDiv.innerHTML = `
        <h3>${post.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞'}</h3>
        <p>${post.content || '–ë–µ–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è'}</p>
        <img src="${post.imageUrl || ''}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" style="max-width: 100%; height: auto;">
        <p><strong>–î–∞—Ç–∞:</strong> ${post.date || '–ù–µ—Ç –¥–∞—Ç—ã'}</p>
        <p><strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong> ${Array.isArray(post.keywords) && post.keywords.length > 0 ? post.keywords.join(', ') : '–ù–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤'}</p>
        <p><strong>–õ–∞–π–∫–∏:</strong> <span id="likes-${post.id}">${post.likes || 0}</span> <button id="likeButton-${post.id}">üëç</button></p>
        <p><strong>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</strong> ${post.rulseId ? `<button id="eventButton-${post.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>` : '–ù–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ'}</p>
        <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h4>
        <div id="comments-${post.id}"></div>
        <input type="text" id="commentInput-${post.id}" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
        <button id="addCommentButton-${post.id}">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    `;
      postsContainer.appendChild(postDiv);

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
      document.getElementById(`likeButton-${post.id}`).onclick = () => likePost(post);
      document.getElementById(`addCommentButton-${post.id}`).onclick = () => addComment(post.id);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
      if (post.rulseId) {
        document.getElementById(`eventButton-${post.id}`).onclick = () => {
          openEventDetails(post.rulseId); // –ü–µ—Ä–µ–¥–∞–µ–º rulseId –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞
        };
      }

      loadComments(post.id);
    }

    function openEventDetails(rulseId) {
      const eventRef = ref(database, 'banners/' + rulseId);
      get(eventRef).then((snapshot) => {
        if (snapshot.exists()) {
          const eventData = snapshot.val();
          document.getElementById('eventTheme').innerText = eventData.theme;
          document.getElementById('eventDescription').innerText = eventData.description;
          document.getElementById('eventMetka').innerText = eventData.metka;
          document.getElementById('eventImage').src = eventData.imageUrl;

          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
          const bannerId = rulseId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º rulseId –∫–∞–∫ bannerId
          const appLink = "https://banner?bannerId=" + bannerId; // –°—Å—ã–ª–∫–∞ –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞
          const webLink = "https://logo-2-0.vercel.app/index.html?bannerId=" + bannerId; // –°—Å—ã–ª–∫–∞ –¥–ª—è –≤–µ–±-—Å–∞–π—Ç–∞
          const finalLink = appLink + "||" + webLink; // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Å—ã–ª–∫–∏
          generateQRCode(finalLink); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥

          // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ QR-–∫–æ–¥
          $('#qrcode').off('click').on('click', function() {
            const links = finalLink.split('||');
            const appLink = links[0];
            const webLink = links[1];

            // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            window.location.href = appLink;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤–µ–±-—Å–∞–π—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
              window.location.href = webLink; // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–µ–±-—Å–∞–π—Ç
            }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 1 —Å–µ–∫—É–Ω–¥—É
          });

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          document.getElementById('eventDetailsModal').style.display = "block";
        } else {
          alert("–î–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        }
      }).catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:", error);
      });
    }

    function generateQRCode(link) {
      $('#qrcode').empty(); // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR-–∫–æ–¥
      $('#qrcode').qrcode({
        text: link,
        width: 200,
        height: 200,
      });
    }


    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('closeEventDetailsModal').onclick = function() {
      document.getElementById('eventDetailsModal').style.display = "none";
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
      if (event.target === document.getElementById('eventDetailsModal')) {
        document.getElementById('eventDetailsModal').style.display = "none";
      }
    }

    function likePost(post) {
      const userId = auth.currentUser .uid; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (!post.likedBy) {
        post.likedBy = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      }

      if (!post.likedBy.includes(userId)) {
        post.likedBy.push(userId); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤ –ª–∞–π–∫–æ–≤
        post.likes++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        set(ref(database, `posts/${post.id}`), post)
          .then(() => {
            document.getElementById(`likes-${post.id}`).innerText = post.likes; // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤
            alert("–ü–æ—Å—Ç –ª–∞–π–∫–Ω—É—Ç!");
          })
          .catch((error) => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:", error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ª–∞–π–∫–Ω—É—Ç—å –ø–æ—Å—Ç.");
          });
      } else {
        alert("–í—ã —É–∂–µ –ª–∞–π–∫–Ω—É–ª–∏ —ç—Ç–æ—Ç –ø–æ—Å—Ç.");
      }
    }

    function addComment(postId) {
      const commentInput = document.getElementById(`commentInput-${postId}`);
      const commentText = commentInput.value.trim();

      if (!auth.currentUser ) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.");
        return;
      }

      if (!commentText) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.");
        return;
      }

      const commentsRef = ref(database, `posts/${postId}/comments`);
      const newComment = {
        text: commentText,
        date: new Date().toISOString(),
        authorId: auth.currentUser .uid
      };

      push(commentsRef, newComment)
        .then(() => {
          commentInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
          loadComments(postId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
          alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!");
        })
        .catch((error) => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:", error);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
        });
    }

    function loadComments(postId) {
      const commentsRef = ref(database, `posts/${postId}/comments`);
      onValue(commentsRef, (snapshot) => {
        const commentsDiv = document.getElementById(`comments-${postId}`);
        commentsDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

        snapshot.forEach((commentSnapshot) => {
          const comment = commentSnapshot.val();
          const commentElement = document.createElement('p');
          commentElement.innerText = `${comment.text}`;
          commentsDiv.appendChild(commentElement);
        });
      }, {
        onlyOnce: true // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
      });
    }
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    function toggleComments(button) {
      const commentsDiv = button.nextElementSibling;
      if (commentsDiv.style.display === 'none') {
        commentsDiv.style.display = 'block';
      } else {
        commentsDiv.style.display = 'none';
      }
    }

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
    function filterPosts() {
      const titleFilter = titleFilterInput.value.toLowerCase();
      const dateFilter = dateFilterInput.value.toLowerCase();
      const keywordsFilter = keywordsFilterInput.value.toLowerCase().split(' ');

      const postsRef = ref(database, 'posts');
      onValue(postsRef, (snapshot) => {
        if (snapshot.exists()) {
          postsContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          const posts = snapshot.val();
          for (const key in posts) {
            if (posts.hasOwnProperty(key)) {
              const post = posts[key];
              if (matchesFilter(post, titleFilter, dateFilter, keywordsFilter)) {
                addPostToView(post);
              }
            }
          }
        } else {
          postsContainer.innerHTML = '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        }
      });
    }

    submitPostButton.onclick = function() {
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      const imageInput = document.getElementById('postImage');
      const imageFile = imageInput.files[0];
      const eventId = document.getElementById('eventSelect').value; // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ

      if (!title || !content || !imageFile || !eventId) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
        return;
      }

      uploadPost(title, content, imageFile, eventId); // –ü–µ—Ä–µ–¥–∞–µ–º eventId
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ—Å—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞–º
    function matchesFilter(post, titleFilter, dateFilter, keywordsFilter) {
      const matchesTitle = post.title.toLowerCase().includes(titleFilter);
      const matchesDate = post.date.includes(dateFilter);
      const matchesKeywords = keywordsFilter.every(keyword => post.keywords.includes(keyword));

      return matchesTitle && matchesDate && matchesKeywords;
    }

    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const bannerId = urlParams.get('bannerId');

      if (bannerId) {
        openEvent(bannerId); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      }

      loadPosts();
      titleFilterInput.addEventListener('input', filterPosts);
      dateFilterInput.addEventListener('input', filterPosts);
      keywordsFilterInput.addEventListener('input', filterPosts);
    }

  </script>
  <style>

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .post {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    #loginModal, #createPostModal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #eventDetailsModal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<button onclick="window.location.href='rulse.html'">–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º</button>

<h1>–ü–æ—Å—Ç—ã</h1>
<button id="loginButton">–í–æ–π—Ç–∏</button>
<button id="createPostButton">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>

<div id="postsContainer"></div>

<div id="loginModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2>–í—Ö–æ–¥</h2>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
    <button id="submitLogin">–í–æ–π—Ç–∏</button>
  </div>
</div>

<div id="createPostModal">
  <div class="modal-content">
    <span class="close" id="closeCreatePostModal">&times;</span>
    <h2>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h2>
    <button onclick="uploadPost()">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
    <select id="eventSelect">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</option>
    </select>
    <input type="text" id="postTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
    <textarea id="postContent" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" required></textarea>
    <input type="file" id="postImage" accept="image/*" required>
    <button id="submitPostButton">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
  </div>
</div>

<div id="eventDetailsModal" style="display: none;">
  <div class="modal-content">
    <span class="close" id="closeEventDetailsModal">&times;</span>
    <h2 id="eventTheme"></h2>
    <img id="eventImage" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" style="max-width: 100%; height: auto;">
    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="eventDescription"></span></p>
    <p><strong>–ú–µ—Ç–∫–∞:</strong> <span id="eventMetka"></span></p>
    <button id="signUpButton">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
    <div id="qrcode"></div>
  </div>
</div>

<input type="text" id="titleFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É">
<input type="text" id="dateFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ">
<input type="text" id="keywordsFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º">

</body>
</html>

